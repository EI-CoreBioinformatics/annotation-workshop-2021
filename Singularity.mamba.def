Bootstrap: docker
From: continuumio/miniconda3

%test
    python3 --version
    # python3 -c "import numpy"
    # TransDecoder.Predict
    # evidence_modeler.pl --help
    # gffread --help
    # gt -help
    # minos --help
    # CPC2 --help

%environment
    export PYTHONDONTWRITEBYTECODE=true
    export BUSCO_CONFIG_FILE=/opt/software/busco/config/container_config.ini
    alias python=python3

%post

    ### Install your packages ###
    conda install -n base -c conda-forge -y micromamba
    apt install -y build-essential
    mkdir -p /usr/local/src
    cd /usr/local/src

    
    export MAMBA_ROOT_PREFIX=/opt/conda/
    micromamba install -n base -c bioconda -c conda-forge -y pip \
       samtools scallop genometools-genometools gffread kallisto stringtie minimap2 hisat2 bioconda::gmap \
       bioconda::transdecoder evidencemodeler trinity diamond prodigal "bioconda::mikado>=2" portcullis \
       bioconda::busco

    # Busco
    mamba remove -y busco
	mkdir -p /opt/software
	cd /opt/software/
	git clone https://gitlab.com/ezlab/busco.git
	cd busco
	python3 setup.py install
	python3 scripts/busco_configurator.py config/config.ini config/container_config.ini
    cat config/container_config.ini

    # CPC2
    cd /usr/local/src
    git clone --depth=1 https://github.com/EI-CoreBioinformatics/CPC2
    cd CPC2
    python3 setup.py bdist_wheel && pip3 install dist/*whl

    # Minos
    cd /usr/local/src/
    git clone --depth=1 https://github.com/EI-CoreBioinformatics/minos minos
    cd minos
    python3 setup.py bdist_wheel
    pip3 install --prefix /usr/local/  dist/*whl

    # Create global folder and cleanup
    apt remove -y wget build-essential && apt clean -y
    conda remove -y micromamba && conda clean -afy    
    mkdir -p /global && cd /global && rm -rf /usr/local/src/*

%apprun snakemake
        snakemake "@"

%apprun minos
        minos "@"

%apprun CPC2
        CPC2 "@"

%apprun analyse_busco
        analyse_busco "@"

%apprun generate_metrics
        generate_metrics "@"

%apprun parse_mikado_gff
        parse_mikado_gff "@"

%apprun protein_completeness
        protein_completeness "@"

%apprun collapse_metrics
        collapse_metrics "@"

%apprun validate_gff3
        validate_gff3 "@"

%apprun create_release_gff3
        create_release_gff3 "@"

%apprun sanity_check
        sanity_check "@"

%apprun parse_mikado_stats
        parse_mikado_stats "@"

%apprun snakemake
	snakemake "@"

%apprun mikado
	mikado "@"

%apprun daijin
    daijin "@"

%apprun prodigal
    prodigal "@"

%apprun samtools
    samtools "@"

%apprun diamond
    diamond "@"

%apprun portcullis
    portcullis "@"

%apprun junctools
    junctools "@"

%apprun kallisto
    kallisto "@"

%apprun stringtie
    stringtie "@"

%apprun scallop
    scallop "@"

%apprun gmap
    gmap "@"

%apprun gffread
    gffread "@"

%apprun gt
    gt "@"

%apprun minimap2
    minimap2 "@"

%apprun hisat2
    hisat2 "@"

%apprun hisat2_build
    hisat2_build "@"

%apprun hisat2_extract_splice_sites.py
    hisat2_extract_splice_sites.py "@"

%apprun paftools.js
    paftools.js "@"

%apprun gmap_build
    gmap_build "@"

%apprun gsnap
    gsnap "@"

%apprun gnuplot
    gnuplot "@"

%apprun plot-bamstats
    plot-bamstats "@"

%apprun EVM
    /usr/local/EVM/evidence_modeler.pl

%apprun Trinity
    Trinity "@"
