Bootstrap: docker
From: ubuntu:20.04

%test
    python3 --version
    python3 -c "import numpy"
    mikado --help
    minos --help

%environment
    export PYTHONDONTWRITEBYTECODE=true
    export PATH=${PATH}:/usr/local/TransDecoder/:/usr/local/TransDecoder/util/:/usr/local/EVM/:/usr/local/salmon/bin/
    export TRINITY_HOME=/usr/local/Trinity
    export PATH=${PATH}:${TRINITY_HOME}:${TRINITY_HOME}/util:${TRINITY_HOME}/Analysis/DifferentialExpression/:${TRINITY_HOME}/Analysis/SuperTranscripts/
    export PATH=${PATH}:${TRINITY_HOME}/util/support_scripts:${TRINITY_HOME}/util/misc:${TRINITY_HOME}/trinity-plugins/BIN

%post

    ### Install your packages ###

    export PYTHONDONTWRITEBYTECODE=true
    apt update
    apt install -y software-properties-common
    add-apt-repository universe
    add-apt-repository multiverse
    add-apt-repository restricted
    apt update
    apt install -y zlib1g-dev build-essential curl autoconf automake git \
    	libbz2-dev libncurses-dev lzma-dev python3 python3-pip liblzma-dev sqlite3

    update-alternatives --install /usr/bin/python python /usr/bin/python3 20
    update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 20

    # Mikado
    pip install wheel
    pip install "Mikado>=2.1.1"

    # CPC2
    mkdir -p /usr/local/src/
    cd /usr/local/src
    git clone --depth=1 https://github.com/EI-CoreBioinformatics/CPC2
    cd CPC2 && pip install .

    # Minos
    cd /usr/local/src
    git clone https://github.com/EI-CoreBioinformatics/minos
    cd minos
    # Uncomment the following line to use the latest tag, rather than the latest *commit*, for Minos
    # git fetch --tags && latestTag=$(git describe --tags `git rev-list --tags --max-count=1`) && git checkout $latestTag
    pip install .

    # Create global folder
    cd /usr/local/src && rm -rf *
    apt purge -y --auto-remove autoconf automake curl git build-essential liblzma-dev \
    	libbz2-dev libncurses-dev
    apt clean -y
    rm -rf /usr/local/src
    mkdir -p /global && cd /global

%apprun snakemake
	snakemake "@"

%apprun mikado
	mikado "@"

%apprun daijin
    daijin "@"

%apprun samtools
    samtools "@"

%apprun minos
    minos "@"

%apprun tabulate
    tabulate "@"

%apprun CPC2
        CPC2 "@"

%apprun analyse_busco
        analyse_busco "@"

%apprun generate_metrics
        generate_metrics "@"

%apprun parse_mikado_gff
        parse_mikado_gff "@"

%apprun protein_completeness
        protein_completeness "@"

%apprun collapse_metrics
        collapse_metrics "@"

%apprun validate_gff3
        validate_gff3 "@"

%apprun create_release_gff3
        create_release_gff3 "@"

%apprun sanity_check
        sanity_check "@"

%apprun parse_mikado_stats
        parse_mikado_stats "@"

%apprun analyse_busco
        analyse_busco "@"
